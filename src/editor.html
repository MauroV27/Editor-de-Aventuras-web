<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adventure Editor</title>
    <link rel="stylesheet" href="editor.css">
    <script src="components.js"></script>
    <script src="abstractionLayer.js"></script>
    <script src="hotspotControler.js"></script>
</head>
<body>
    <div class="container">
        <div class="frameViewContainer">
            <div class="frameRender">
                <!-- <div class="hotSpotsRenderContainer"></div> -->

                <!-- <img id="currentFrameView" src="" alt=""> -->
                <!-- Canvas view for render image and hotspots -->
                <canvas id="frameCanvas" width="960px" height="540px"></canvas>
            </div>
        </div>

        <div class="verticalPanel">
            <div class="frameProperties">
                <h3 id="nameFrameView">Frame name</h3>
                <div class="hotspotList"></div>
                <button onclick="openPopup()" class="btn-action">+ Área clicavel</button>
            </div>
            
            <div class="framesManager">
                <h3>Lista de frames:</h3>

                <div class="framesList"></div>

                <button id="btnAddFrame" class="btn-action" onclick="addFrame()">Novo Frame</button>

            </div>
        </div>

    </div>

    <div id="modalOne" class="modal"></div>

    <script>

        const canvas = document.querySelector('#frameCanvas');
        const ctx = canvas.getContext('2d');

        const hotSpotsListRender= []; // List of hotspots that appear in current frame loaded in canvas
        let selectedShapeReference = null; // To store moveFunction in shape
        let editingHotSpot = false; // bool var to allow edit hotspot

        let image; 
        const imgProperties = {};
        let indexFrameView = -1;
        let indexHotSpot = -1;

        let mouseX, mouseY; // like p5js, this vars store position of mouse in canvas screen

        const frameManager = new FrameManager(); // Handle all data in aplication
        
        // Code for test quickly elements ---------------------------------
        // REMOVE-BLOCK :
        // frameManager.addFrame( new Frame("https://png.pngtree.com/background/20230613/original/pngtree-view-of-the-outer-space-with-all-the-planets-picture-image_3403234.jpg", "Space Frame") );
        const testFrame0 = new Frame("img-teste.png", "FRame teste");
        testFrame0.addHotSpot( new HotSpot( new CircleShape(100, 250, 50), 1) )
        frameManager.addFrame( testFrame0 );

        const testeFrameHs = new Frame("img-teste.png", "Borrao teste");
        testeFrameHs.addHotSpot( new HotSpot( new RectShape(50, 80, 50, 50), 0));
        testeFrameHs.addHotSpot( new HotSpot( new RectShape(200, 100, 50, 50), 0));

        frameManager.addFrame(testeFrameHs );

        // Code for test quickly elements ----------------------------- END

        //#region :: Functions to manager canvas activity : -----------------------------

        //Function to start code ( setup operations ) :
        function start() {
            renderFrameList();

            window.addEventListener("mousemove", trackMousePosition, false);
            window.addEventListener("mouseenter", trackMousePosition, false);
            window.addEventListener("mouseleave", trackMousePosition, false);
        
            window.addEventListener("keydown", function(e){
                // FOR TEST 
                if ( e.key == "s" ){
                    const a = frameManager.exportDataInJSON(canvas.width, canvas.height);
                    console.log(a)
                    console.log(JSON.stringify(a, undefined, 5))

                    const confirmDonwload = confirm("Deseja baixar o arquivo (.json) com os dados da a´plicação?")
                    if ( confirmDonwload ){
                        generateJSONFileByData(JSON.stringify(a, undefined, 5), "adventure-js-test.json", document)
                    }
                }
            })
        }

        /** 
         * renderOnCanvas :: Manager the renderization of canvas screen. Can handle one single update or many by oneTime properties
         * @param {boolean} oneTime = false :: if true renders only one sigle frame. The default value implies that will be render continuos frames
        */
        function renderOnCanvas(oneTime = false){
            background("#fff");
            fill("#333333");
            rect(10, 10, canvas.width - 20, canvas.height - 20);

            // Render frame image : 
            drawImage(image, imgProperties.xOffset, imgProperties.yOffset, imgProperties.newWidth, imgProperties.newHeight )

            // Render hotspots : 
            for ( const hs of hotSpotsListRender ){
                if ( hs != undefined && hs != null ){
                    hs.render();
                }
            }

            if ( oneTime == true ) return;

            if ( selectedShapeReference != null ) {
                selectedShapeReference.move(mouseX, mouseY);
            }

            requestAnimationFrame(renderOnCanvas);
        }

        // Convert mouse event to canvas region
        function trackMousePosition(event){
            let rect = canvas.getBoundingClientRect();
            mouseX = event.pageX - rect.left;
            mouseY = event.pageY - rect.top;
        }

        function move(event) {
            if ( editingHotSpot == false ) return;
            if ( selectedShapeReference == null ) return;

            selectedShapeReference.move( mouseX, mouseY );
        }

        function deselect(event){
            if ( editingHotSpot == false ) return;
            if (selectedShapeReference != null && selectedShapeReference.stopMove != undefined ) { selectedShapeReference.stopMove(); }

            frameManager.updateHotSpotAreaInFrame(indexFrameView, indexHotSpot, hotSpotsListRender[indexHotSpot].getParams());
            hotSpotsListRender[indexHotSpot].setEditable(false);
            selectedShapeReference = null;
            editingHotSpot = false;
            
            indexHotSpot = -1;
            renderOnCanvas(true)
        }
        

        function selectPoint( event ){
            // Select a point or shape that users was clicked
            if ( editingHotSpot == false ) return;

            const point = checkPoint(mouseX, mouseY);

            if ( point ){
                selectedShapeReference = point;
                return;
            } 

            const getShape = checkCollision(mouseX, mouseY);

            if ( getShape == null ) return;

            const moveFunc = getShape.moveFunction(); // recebe uma função que move o shape selecionado
            
            selectedShapeReference = {
                move : (x, y) => {
                    moveFunc(x, y);
                }
            }
           
        }

        function checkCollision(x, y) {

            for ( let i = hotSpotsListRender.length - 1; i >= 0 ; i-- ){
                const sp = hotSpotsListRender[i];
                if ( sp.checkCollision( x, y ) ){
                    return sp;
                }
            }

            return null;
        }

        function checkPoint(x, y){
            for ( const sp of hotSpotsListRender ){
                for ( const p of sp.getPoints() ){
                    const d = Math.sqrt( Math.pow(x - p.x, 2) + Math.pow(y - p.y, 2));
                    if ( d < p.radius ){
                        return p;
                    }
                }

            }

            return null;
        }

        // window.onclick = selectPoint
        window.onmousemove = move;
        window.onmousedown = selectPoint;  // down
        window.onmouseup = deselect;       // up
            
        start();

        //#endregion Functions to manager canvas activity : ------------------------- END

        //#region :: Frame functions --------------------------------------

        function addFrame(){
            const url = prompt("Digite o endereço de uma imagem : ");
            const frameName = prompt("Digite o nome do frame :") || "Frame " + ( frameManager.getFrames().length + 1 )

            if ( url == null ) return;

            frameManager.addFrame( new Frame(url, frameName) );
            renderFrameList();
        }

        function renderFrameList(){
            const frameList = document.querySelector(".framesList");
            let textHTML = ''

            for ( const index in frameManager.getFrames() ){

                const frame = frameManager.getFrame( index );
                const fName = frame.getName();

                textHTML += `
                    <div class="itemElement">
                        <img src="${frame.getImage()}" alt="imagemN" onclick="selectFrame(${index})">
                        <p class="frameName" title="${fName}">${fName.slice(0, 12)}</p>
                        <button onclick="removeFrame(${index})">X</button>
                    </div>`                    
            }
            
            frameList.innerHTML = textHTML;
        }

        function removeFrame( index ){
            const confirm = window.confirm("Deseja deletar esse frame?");

            if ( indexFrameView == index ){
                indexFrameView = -1;
                renderCurrentFrame();
            }

            if ( confirm ){
                // TODO : Validate index before acess : 
                frameManager.deleteFrame( index );
                renderFrameList();
            }
        }

        function selectFrame(index) {
            indexFrameView = index;
            renderCurrentFrame();
        }

        function renderCurrentFrame(){
            
            const frameName = document.querySelector('#nameFrameView');
            const frameHotSpots = document.querySelector('.hotspotList');

            if ( indexFrameView < 0 ){
                frameName.textContent = "";
                frameHotSpots.innerHTML = "";
                return;
            }

            const frame = frameManager.getFrame( indexFrameView );
            hotSpotsListRender.length = 0; // clear list of hotspots in render

            const hotSpotsInFrame = frame.getHotSpots();

            frameName.textContent = frame.getName();

            let textHTML = ''

            for ( const index in hotSpotsInFrame ){
                const hs = hotSpotsInFrame[ index ];
                if ( hs == null ) continue;

                hotSpotsListRender.push( adaptHotSpotToInteractiveRenderShape(hs) )
                const gotoFrame = frameManager.getFrame( hs.getNextFrame() ).getName();

                textHTML += `                        
                    <div class="itemElement">
                        <p>${gotoFrame}</p>
                        <div class="actionHotSpot">
                            <button onclick="editHotSpot(${indexFrameView}, ${index})">✎</button>
                            <button onclick="deleteHotSpot(${indexFrameView}, ${index})">🗑️</button>
                        </div>
                    </div>`;
            }

            frameHotSpots.innerHTML = textHTML;

            image = new Image();
            image.src = frame.getImage();
            image.onload = function () {
                var wrh = image.width / image.height;
                var newWidth = canvas.width;
                var newHeight = newWidth / wrh;
                if (newHeight > canvas.height) {
                            newHeight = canvas.height;
                    newWidth = newHeight * wrh;
                }
                imgProperties.xOffset = clamp(newWidth < canvas.width ? ((canvas.width - newWidth) / 2) : 0, 10, canvas.width - 20);
                imgProperties.yOffset = clamp(newHeight < canvas.height ? ((canvas.height - newHeight) / 2) : 0, 10, canvas.height - 20);
                imgProperties.newHeight = clamp(newHeight, 10, canvas.height - 20);
                imgProperties.newWidth = clamp(newWidth, 10, canvas.width - 20);

                renderOnCanvas(true);
            };
        }

        //#endregion :: Frame functions ---------------------------------- END

        //#region :: HotSpot functions ------------------------------------


        function openPopup() {

            if ( indexFrameView < 0 ){
                alert("Crie ou selecione um frame para adicionar uma área clicavel!");
                return;
            }

            const modal = document.querySelector("#modalOne");
            modal.style.display = "block";

            let options = ""

            for ( const index in frameManager.getFrames() ){
                if ( index != indexFrameView ){
                    options += `<option value="${index}">${frameManager.getFrame(index).getName()}</option>`
                }
            }

            modal.innerHTML = `
                <div class="modal-content" id="modalReference">
                    <h3>Criar interação</h3>
                
                    <!-- <a class="close">&times;</a> -->
                    <div class="modal-row">
                        <label for="hotSpotShapeType">Tipo de interação:</label>
                        <select name="hotSpotShapeType" id="hotSpotShapeType">
                            <option value="RECT">Rect</option>
                            <option value="CIRCLE">Circle</option>
                        </select>
                    </div>

                    <div class="modal-row">
                        <label for="hotSpotTarget">Vá para o frame :</label>
                        <select name="hotSpotTarget" id="hotSpotTarget">
                            ${options}
                        </select>
                    </div>

                    <div class="modal-row">
                        <button onclick="addHotSpot()">Adicionar</button>
                        <button onclick="closePopup()">Cancelar</button>
                    </div>
                </div>`            
        }

        function closePopup() {
            const modal = document.querySelector("#modalOne");
            modal.style.display = "none";
            modal.innerHTML = ""
        }

        function addHotSpot(){
            const shapeType = document.getElementById("hotSpotShapeType"); 
            const taregtFrame = document.getElementById("hotSpotTarget");

            const [centerX, centerY] = [canvas.width/2, canvas.height/2];

            // TODO : Implement base for different shape types :
            let shape = null;
            switch ( shapeType.value ) {
                case "RECT":
                    shape = new RectShape(centerX - 25, centerY - 25, 50, 50);
                    break;

                case "CIRCLE":
                    shape = new CircleShape(centerX, centerY, 50);
                    break;
            
                default:
                    return;
                    break;
            } 

            if ( shape == null || taregtFrame == null ){
                alert("Problem in create hotspot, please try again!")
                return;
            }

            const hs = new HotSpot(shape, parseInt(taregtFrame.value));

            frameManager.getFrame( indexFrameView ).addHotSpot( hs );
            closePopup();
            selectFrame( indexFrameView );
        }

        function editHotSpot(frameIndex, hotSpotIndex ) {
            if ( frameIndex != indexFrameView ) return;

            const frame = frameManager.getFrame( indexFrameView );
            const hs = frame.getHotSpots()[hotSpotIndex];
            // TODO : Add param to modify hotspot;        

            // TODO : Implement prompt for customize target
            // const newHotSpotTarget = confirm("Deseja mudar para onde a área clicavel leva? ");
            // if ( newHotSpotTarget ){
                
            // }

            for ( const index in hotSpotsListRender){
                hotSpotsListRender[index].setEditable(index == hotSpotIndex);
            }
            editingHotSpot = true;
            indexHotSpot = hotSpotIndex;
            renderOnCanvas();
        }

        function deleteHotSpot(frameIndex, hotSpotIndex) {
            if ( frameIndex != indexFrameView ) return;

            const confirm = window.confirm("Deseja deletar essa área clicavel?");

            if ( confirm ){
                const frame = frameManager.getFrame( indexFrameView );

                frame.deleteHotSpot( parseInt(hotSpotIndex) );
                renderCurrentFrame();
            }

        }

        //#endregion HotSpot functions -------------------------------- END

    </script>
</body>
</html>